<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no">
		<!-- <link rel="stylesheet" type="text/css" href="css/siimple.min.css"> -->
		<!-- link rel="stylesheet" type="text/css" href="css/style.css" -->
		<!-- link rel="shortcut icon" href="img/favicon.png" -->

		<title>luOS9 IoT ADC-DAC control page</title>
		
		<style>
			ul.navbar {
				list-style-type: none;
				margin-bottom: 32px;
				padding: 0;
				overflow: hidden;
				background-color: #333;
			}
			ul.navbar li {
				float: left;
			}
			ul.navbar li a {
				display: block;
				color: white;
				text-align: center;
				padding: 14px 16px;
				text-decoration: none;
			}
			ul.navbar li a:hover:not(.active) {
				background-color: #111;
			}
			ul.navbar li a.active {
				background-color: #09a0f6;
			}
			@media screen and (max-width: 600px){
				ul.navbar li.right, 
				ul.navbar li {float: none;}
			}


			td {
				height: 40px;
				width: 50%;
				font-size: 12px; color: blue; font-family: Trebuchet, Arial, sans-serif; font-weight: bold;
			}
			label {
				display: inline-block;
				vertical-align: middle;
				line-height: 30px;
				color: #333;
			}
			meter {
				width: 40%;
				height: 15px;
				display: inline-block;
				vertical-align: middle;
				line-height: 30px;
			}


			input[type=range] {
				width:70%;
				height: 31px;
				display: inline-block;
				vertical-align: middle;
			  
				-webkit-appearance: none;
				background: transparent; /* Otherwise white in Chrome */

				background: #DDD; /*#CDD1DA;*/
				border: 2px solid gray; border-radius: 20px;
			}
			input[type=range]:focus {
				outline: none; /* Removes the blue border. You should probably do some kind of focus styling for accessibility reasons though. */
			}


			/**
			 * webkit
			 */
			input[type=range]::-webkit-slider-thumb {
				display: block; width: 30px; height: 25px; margin: 6px;
				background: #FFFFFF;
				position: absolute; top: 0; bottom: 0;
				border: 2px solid #03A9F4; border-radius: 20px;

				cursor: pointer;
				z-index: 20;
				-webkit-appearance: none;
				position: relative;
			}


			/**
			 * moz
			 */
			input[type=range]::-moz-range-thumb {
				display: block; width: 30px; height: 25px; margin: 6px;
				background: #FFFFFF;
				position: absolute; top: 0; bottom: 0;
				border: 2px solid #03A9F4; border-radius: 20px;

				cursor: pointer;
				z-index: 20;
			}


			/**
			 * ms
			 */
			input[type=range]::-ms-fill-lower {
				background: transparent;
			}

			input[type=range]::-ms-thumb {
				display: block; width: 30px; height: 25px; margin: 6px;
				background: #FFFFFF;
				position: absolute; top: 0; bottom: 0;
				border: 2px solid #03A9F4; border-radius: 20px;

				cursor: pointer;
				z-index: 20;
			}

			input[type=range]::-ms-track {
			  /*width: 100%;*/
			  cursor: pointer;

			  /* Hides the slider so custom styles can be added */
			  background: transparent; 
			  border-color: transparent;
			  color: transparent;
			}
		</style>

<script language="javascript" type="text/javascript">

  var wsUri = "ws://"+window.location.host+"/dev";
  var output;
  
  var ws;
  var retries;
  var val = 0.0;
  
  var rcvd_tm = 0;
  var dac = -1.0;
  var rd_ch = 0; //-2 = dac, -3 = int adc, 0-3 = ext adc
  
  var interval_timeout = 0;

  function setMsg(cls, text) {
    sbox = document.getElementById('status_box');
    sbox.className = "alert alert-" + cls;
    sbox.innerHTML = text;
    //console.log(text);
  }
  function init()
  {
    output = document.getElementById("output");

    wsOpen();

	setInterval(
		function() { 
			//setMsg("info", "tst 1");
			interval_timeout++;
			
			if(interval_timeout > 30*8){
				rd_ch = 0;
				interval_timeout = 0;
				return;
			}else if(rd_ch > 15){
				return;
			}
			
			if(ws === undefined || ws.readyState == 3 || retries++ > 50)
				wsOpen();
			if(ws.readyState != 1) return;

			if(rcvd_tm > 0){
				rcvd_tm--;
				return;
			}
			
			var cmd = "adc[" + rd_ch + "]=" + (rd_ch == -2 ? dac : -1.0);      
			doSend(cmd);
			
			rcvd_tm = 400;
			
			if(rd_ch == -3)
				rd_ch = -2;
			else if(rd_ch == -2){
				dac = -1.0;
				rd_ch = 16;
			}else if(rd_ch >= 3)
				rd_ch = -3;
			else
				rd_ch++;
		}
		, 200
	);

  }

  function wsOpen()
  {
    if (ws === undefined || ws.readyState != 0) {
      if (retries > 50)
        setMsg("error", "WebSocket timeout, retrying..");
      else
        setMsg("info", "Opening WebSocket..");

      ws = new WebSocket(wsUri);
      ws.onopen = function(evt) { onOpen(evt) };
      ws.onclose = function(evt) { onClose(evt) };
      ws.onmessage = function(evt) { onMessage(evt) };
      ws.onerror = function(evt) { onError(evt) };
    
      //wsOpenStream();
      retries = 0;  
    }
  }

  function onOpen(evt)
  {
//    writeToScreen("CONNECTED");
    setMsg("info", '<span style="color: red;">CONNECTED</span> ');
  }

  function onClose(evt)
  {
//    writeToScreen("DISCONNECTED");
    setMsg("info", '<span style="color: red;">DISCONNECTED</span> ');
  }

  function onMessage(evt)
  {
//    writeToScreen('<span style="color: blue;">RECEIVED:' + evt.data+'</span>');
    setMsg("info", '<span style="color: blue;">RECEIVED:</span> ' + evt.data);
    
    //var v;
    var ar = evt.data.split("=");
    var el = document.getElementById(ar[0]);
    el.innerHTML = " " + ar[1] + "%";
    
    el = document.getElementById(ar[0] + "g");
    el.value = parseFloat(ar[1]);
    
    //console.log(ar[0] + "g = " + el.value);
    
//    websocket.close();

	retries = 0;
	
	rcvd_tm = 0;
  }

  function onError(evt)
  {
    setMsg("error", '<span style="color: red;">ERROR:</span> ' + evt.data);
  }

  function doSend(message)
  {
//    writeToScreen("SENT: " + message); 
//	setMsg("info", "SENT: " + message);
    setMsg("info", '<span style="color: blue;">SENT:</span> ' + message);
    
	 if (ws.readyState == 3 || retries++ > 50)
		wsOpen();
	 else 
	 if (ws.readyState == 1)
		ws.send(message);
  }

  function writeToScreen(message)
  {
    var pre = document.createElement("p");
    pre.style.wordWrap = "break-word";
    pre.innerHTML = message;
    output.appendChild(pre);
  }
  
  function sndDacSldr(adc_num) {
	if(adc_num == -2){ 
		var v = document.getElementById("adc[" + adc_num +"]g").value;
		var cmd = "adc[" + adc_num + "]=" + v;      
		doSend(cmd);
		dac = v;
	}
  }

  window.addEventListener("load", init, false);

</script>

	</head>
	<body>
		<ul class="navbar">
			<li><a href="/">Home</a></li>
			<li><a href="pio_dev.html">PIO dev</a></li>
			<li><a href="pwm_dev.html">PWM dev</a></li>
			<li><a class="active" href="adc_dac_dev.html">ADC-DAC dev</a></li>
			<li><a href="about.html">About</a></li>
			<li><a href="test.lua?hello=world&test=CGI">Test Lua CGI</a></li>
		</ul>
		
		<div> <!-- class="grid main"> -->
			<h1>ADC-DAC Test</h1>
		
			<div id="status_box" class="alert alert-info"  align="center">Loading..</div>

			<div class="cover" style="width: 95%; margin: 0 auto;">
				<table style="width: 100%;">
					<tr><td>
						<span style="color: violet; font-size: 18px;">ext ADCs:</span>
					</td>
					<td></td></tr>
					
					<tr><td>
					<meter min="0.0" max="100.0" value="50.0" name="lbutton8" id="adc[0]g"></meter>
					<label for="adc[0]g">ADC 0 (0) =<span style="color:green;" id="adc[0]"> 50.0%</span></label>
					</td>
					<td>
					<meter min="0.0" max="100.0" value="50.0" name="lbutton8" id="adc[1]g"></meter>
					<label for="adc[1]g">ADC 1 (1) =<span style="color:green;" id="adc[1]"> 50.0%</span></label>
					</td></tr>
					
					<tr><td>
					<meter min="0.0" max="100.0" value="50.0" name="lbutton8" id="adc[2]g"></meter>
					<label for="adc[2]g">ADC 2 (2) =<span style="color:green;" id="adc[2]"> 50.0%</span></label>
					</td>
					<td>
					<meter min="0.0" max="100.0" value="50.0" name="lbutton8" id="adc[3]g"></meter>
					<label for="adc[3]g">ADC 3 (3) =<span style="color:green;" id="adc[3]"> 50.0%</span></label>
					</td></tr>
					
					<tr><td>
						<span style="color: violet; font-size: 18px;">int ADC:</span>
					</td></tr>
					
					<tr><td>
					<meter min="0.0" max="100.0" value="50.0" name="lbutton8" id="adc[-3]g"></meter>
					<label for="adc[-3]g">int ADC (-3) =<span style="color:green;" id="adc[-3]"> 50.0%</span></label>
					</td>
					<td></td></tr>
				</table>
				<table style="width: 100%;">
					<tr><td>
						<span style="color: violet; font-size: 18px;">DAC:</span>
					</td></tr>
					
					<tr><td>
					<input type="range" min="0.0" max="100.0" step="0.1" name="lbutton8" id="adc[-2]g" oninput="sndDacSldr(-2)">
					<label for="adc[-2]g">DAC (-2) =<span style="color:green;" id="adc[-2]"> 50.0%</span></label>
					</td></tr>
				</table>
			</div>
			
			<div id="output"></div>
		</div>

	</body>
	
